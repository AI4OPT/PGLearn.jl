name: Sysimage Test
on:
  push:
    branches:
      - main
      - release-*
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  sysimage:
    name: Test Sysimage Creation and Usage
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1'
          arch: x64
      - name: Install dependencies
        run: julia --project=. -e 'using Pkg; Pkg.instantiate()'
      - name: Create precompile statements
        run: |
          mkdir -p app
          julia --project=. -t1 --trace-compile=app/precompile.jl exp/sampler.jl exp/config.toml 1 1 || true
      - name: Create sysimage
        run: julia --project=. -t8 slurm/make_sysimage.jl
      - name: Verify sysimage exists
        run: |
          if [ ! -f app/julia.so ]; then
            echo "ERROR: Sysimage was not created at app/julia.so"
            exit 1
          fi
          echo "Sysimage created successfully at app/julia.so"
          ls -lh app/julia.so
      - name: Test sysimage with simple script
        run: |
          julia --project=. --sysimage=app/julia.so -e '
            using PGLearn
            using PowerModels
            using JuMP
            using Ipopt
            using Clarabel
            using HiGHS
            println("Successfully loaded all packages from sysimage")
            println("PGLearn module: ", PGLearn)
          '
      - name: Test sysimage with README example
        run: |
          julia --project=. --sysimage=app/julia.so -e '
            using PGLib, PowerModels
            using PGLearn
            using Ipopt
            
            # Load data from PGLib case
            pm_network = PowerModels.make_basic_network(pglib("14_ieee"))
            data = PGLearn.OPFData(pm_network)
            
            # Build OPF optimization model
            # To switch formulations, replace ACOPF with, e.g., DCOPF or SOCOPF
            opf = PGLearn.build_opf(PGLearn.ACOPF, data, Ipopt.Optimizer)
            
            # Solve and extract result
            PGLearn.solve!(opf)
            res = PGLearn.extract_result(opf)
            
            println("Successfully ran README example with sysimage!")
            println("Objective value: ", res["meta"]["objective"])
          '